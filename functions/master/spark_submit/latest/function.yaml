kind: job
metadata:
  name: spark-submit
  tag: ''
  hash: 400b77a401c49016379bea4732dc6a9aae42c347
  project: default
  categories: []
spec:
  command: ''
  args: []
  image: mlrun/mlrun
  env: []
  default_handler: spark_submit
  description: ''
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlcgoKZnJvbSBtbHJ1biBpbXBvcnQgZ2V0X29yX2NyZWF0ZV9jdHgKZnJvbSBrdWJlcm5ldGVzIGltcG9ydCBjb25maWcsIGNsaWVudApmcm9tIGt1YmVybmV0ZXMuc3RyZWFtIGltcG9ydCBzdHJlYW0KaW1wb3J0IHlhbWwKZnJvbSBwYXRobGliIGltcG9ydCBQYXRoCmltcG9ydCBvcwoKY2xhc3MgSzhTQ2xpZW50KG9iamVjdCk6CgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGxvZ2dlciwgbmFtZXNwYWNlPSdkZWZhdWx0LXRlbmFudCcsIGNvbmZpZ19maWxlPU5vbmUpOgogICAgICAgIHNlbGYubmFtZXNwYWNlID0gbmFtZXNwYWNlCiAgICAgICAgc2VsZi5sb2dnZXIgPSBsb2dnZXIKICAgICAgICBzZWxmLl9pbml0X2s4c19jb25maWcoY29uZmlnX2ZpbGUpCiAgICAgICAgc2VsZi52MWFwaSA9IGNsaWVudC5Db3JlVjFBcGkoKQoKICAgIGRlZiBfaW5pdF9rOHNfY29uZmlnKHNlbGYsIGNvbmZpZ19maWxlKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGNvbmZpZy5sb2FkX2luY2x1c3Rlcl9jb25maWcoKQogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCd1c2luZyBpbi1jbHVzdGVyIGNvbmZpZy4nKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGNvbmZpZy5sb2FkX2t1YmVfY29uZmlnKGNvbmZpZ19maWxlKQogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygndXNpbmcgbG9jYWwga3ViZXJuZXRlcyBjb25maWcuJykKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHJhaXNlIFJ1bnRpbWVFcnJvcigKICAgICAgICAgICAgICAgICAgICAnY2Fubm90IGZpbmQgbG9jYWwga3ViZXJuZXRlcyBjb25maWcgZmlsZSwnCiAgICAgICAgICAgICAgICAgICAgJyBwbGFjZSBpdCBpbiB+Ly5rdWJlL2NvbmZpZyBvciBzcGVjaWZ5IGl0IGluICcKICAgICAgICAgICAgICAgICAgICAnS1VCRUNPTkZJRyBlbnYgdmFyJykKCiAgICBkZWYgZ2V0X3NoZWxsX3BvZF9uYW1lKHNlbGYsIHBvZF9uYW1lPSdzaGVsbCcpOgogICAgICAgIHNoZWxsX3BvZCA9IHNlbGYudjFhcGkubGlzdF9uYW1lc3BhY2VkX3BvZChuYW1lc3BhY2U9c2VsZi5uYW1lc3BhY2UpCiAgICAgICAgZm9yIGkgaW4gc2hlbGxfcG9kLml0ZW1zOgogICAgICAgICAgICBpZiBwb2RfbmFtZSBpbiBpLm1ldGFkYXRhLm5hbWU6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCIlc1x0JXNcdCVzIiAlIChpLnN0YXR1cy5wb2RfaXAsIGkubWV0YWRhdGEubmFtZXNwYWNlLCBpLm1ldGFkYXRhLm5hbWUpKQogICAgICAgICAgICAgICAgc2hlbGxfbmFtZSA9IGkubWV0YWRhdGEubmFtZQogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICByZXR1cm4gc2hlbGxfbmFtZQoKICAgIGRlZiBleGVjX3NoZWxsX2NtZChzZWxmLCBjbWQsIHNoZWxsX3BvZF9uYW1lID0gJ3NoZWxsJyk6CiAgICAgICAgc2hlbGxfbmFtZSA9IHNlbGYuZ2V0X3NoZWxsX3BvZF9uYW1lKHNoZWxsX3BvZF9uYW1lKQogICAgICAgIGV4ZWNfY29tbWFuZCA9IFsKICAgICAgICAgICAgJy9iaW4vYmFzaCcsCiAgICAgICAgICAgICctYycsCiAgICAgICAgICAgIGNtZF0KICAgICAgICByZXNwID0gc3RyZWFtKHNlbGYudjFhcGkuY29ubmVjdF9nZXRfbmFtZXNwYWNlZF9wb2RfZXhlYywKICAgICAgICAgICAgICAgICAgICAgIHNoZWxsX25hbWUsCiAgICAgICAgICAgICAgICAgICAgICBzZWxmLm5hbWVzcGFjZSwKICAgICAgICAgICAgICAgICAgICAgIGNvbW1hbmQ9ZXhlY19jb21tYW5kLAogICAgICAgICAgICAgICAgICAgICAgc3RkZXJyPVRydWUsIHN0ZGluPUZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgc3Rkb3V0PVRydWUsIHR0eT1GYWxzZSxfcHJlbG9hZF9jb250ZW50PUZhbHNlKQogICAgICAgIAogICAgICAgIAogICAgICAgIHN0ZGVyciA9IFtdCiAgICAgICAgc3Rkb3V0ID0gW10KICAgICAgICB3aGlsZSByZXNwLmlzX29wZW4oKToKICAgICAgICAgICAgcmVzcC51cGRhdGUodGltZW91dD1Ob25lKQogICAgICAgICAgICBpZiByZXNwLnBlZWtfc3RkZXJyKCk6CiAgICAgICAgICAgICAgICAgc3RkZXJyLmFwcGVuZChyZXNwLnJlYWRfc3RkZXJyKCkpCiAgICAgICAgICAgIGlmIHJlc3AucGVla19zdGRvdXQoKToKICAgICAgICAgICAgICAgICBzdGRvdXQuYXBwZW5kKHJlc3AucmVhZF9zdGRvdXQoKSkKICAgICAgICAgICAKICAgICAgICBlcnIgPSByZXNwLnJlYWRfY2hhbm5lbCgzKQogICAgICAgIGVyciA9IHlhbWwuc2FmZV9sb2FkKGVycikKICAgICAgICBpZiBlcnJbJ3N0YXR1cyddID09ICdTdWNjZXNzJzoKICAgICAgICAgICAgcmMgPSAwCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmMgPSBpbnQoZXJyWydkZXRhaWxzJ11bJ2NhdXNlcyddWzBdWydtZXNzYWdlJ10pCiAgICAgICAgCiAgICAgICAgc3Rkb3V0X2Zvcm1hdGVkPScnCiAgICAgICAgZm9yIGVhY2ggaW4gc3Rkb3V0OgogICAgICAgICAgICBzdGRvdXRfZm9ybWF0ZWQgKz0gZWFjaAogICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlNURE9VVDogJXMiJSBzdGRvdXRfZm9ybWF0ZWQpCiAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiUkM6ICVzIiUgcmMpCiAgICAgICAgCiAgICAgICAgc3RkZXJyX2Zvcm1hdGVkPScnCiAgICAgICAgZm9yIGVhY2ggaW4gc3RkZXJyOgogICAgICAgICAgICBzdGRlcnJfZm9ybWF0ZWQgKz0gZWFjaAogICAgICAgIGlmIHJjICE9IDA6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlNUREVSUjogJXMiJSBzdGRlcnJfZm9ybWF0ZWQpCiAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbignRXhlY3V0aW9uX2Vycm9yJywgc3RkZXJyX2Zvcm1hdGVkICsgc3Rkb3V0X2Zvcm1hdGVkKQogICAgCmRlZiBuYl9vcl9weShweXNwYXJrX2NvbW1hbmQpOgogICAgaWYgcHlzcGFya19jb21tYW5kLmVuZHN3aXRoKCcuaXB5bmInKToKICAgICAgICBmcm9tIG1scnVuIGltcG9ydCBjb2RlX3RvX2Z1bmN0aW9uCiAgICAgICAgZGlyID0gUGF0aChweXNwYXJrX2NvbW1hbmQpLnBhcmVudAogICAgICAgIGZpbGUgPSAgUGF0aChweXNwYXJrX2NvbW1hbmQpLnN0ZW0KICAgICAgICBweXRob25fZmlsZSA9IG9zLnBhdGguam9pbihkaXIsZmlsZSArJy5weScpCiAgICAgICAgY29kZV90b19mdW5jdGlvbihraW5kPSJsb2NhbCIsZmlsZW5hbWU9cHlzcGFya19jb21tYW5kLGNvZGVfb3V0cHV0PXB5dGhvbl9maWxlKQogICAgICAgIHJldHVybiBweXRob25fZmlsZQogICAgZWxzZToKICAgICAgICByZXR1cm4gcHlzcGFya19jb21tYW5kICAgICAKCgpkZWYgc3BhcmtfY29tbWFuZF9idWlsZGVyKG5hbWUsIGNsYXNzX25hbWUsIGphcnMsIHBhY2thZ2VzLCBzcGFya19vcHRpb25zLHB5c3BhcmtfY29tbWFuZD0nJyxweXNwYXJrX3BhcmFtcz0nJyk6CiAgICBjbWQgPSAnc3Bhcmstc3VibWl0JwogICAgaWYgbmFtZToKICAgICAgICBjbWQgKz0gJyAtLW5hbWUgJyArIG5hbWUKCiAgICBpZiBjbGFzc19uYW1lOgogICAgICAgIGNtZCArPSAnIC0tY2xhc3MgJyArIGNsYXNzX25hbWUKCiAgICBpZiBqYXJzOgogICAgICAgIGNtZCArPSAnIC0tamFycyAnICsgamFycwoKICAgIGlmIHBhY2thZ2VzOgogICAgICAgIGNtZCArPSAnIC0tcGFja2FnZXMgJyArIHBhY2thZ2VzCgogICAgaWYgc3Bhcmtfb3B0aW9uczoKICAgICAgICBjbWQgKz0gJyAnICsgc3Bhcmtfb3B0aW9ucwoKICAgIGlmIHB5c3BhcmtfY29tbWFuZDoKICAgICAgICBjbWQgKz0gJyAnICsgbmJfb3JfcHkocHlzcGFya19jb21tYW5kKQogICAgICAgICAgICAKICAgIGlmIHB5c3BhcmtfcGFyYW1zOgogICAgICAgIGNtZCArPSAnICcgKyBweXNwYXJrX3BhcmFtcwogICAgICAgIAogICAgcmV0dXJuIGNtZAoKCmRlZiBzcGFya19zdWJtaXQoY29udGV4dCwgdjNpb19hY2Nlc3Nfa2V5LCBuYW1lPU5vbmUsIGNsYXNzX25hbWU9Tm9uZSwgamFycz1Ob25lLCBwYWNrYWdlcz1Ob25lLCBzcGFya19vcHRpb25zPScnLHB5c3BhcmtfY29tbWFuZD0nJyxweXNwYXJrX3BhcmFtcz0nJyxzaGVsbF9wb2RfbmFtZT0nc2hlbGwnKToKICAgICIiInNwYXJrX3N1Ym1pdCBmdW5jdGlvbgogICAgCiAgICBzdWJtaXRpbmcgc3BhcmsgdmlhIHNoZWxsCiAgICAKICAgIDpwYXJhbSBuYW1lOiAgICAgICAgQSBuYW1lIG9mIHlvdXIgYXBwbGljYXRpb24uCiAgICA6cGFyYW0gY2xhc3NfbmFtZTogIFlvdXIgYXBwbGljYXRpb24ncyBtYWluIGNsYXNzIChmb3IgSmF2YSAvIFNjYWxhIGFwcHMpLgogICAgICAgICAgICAgICAgICAgICAgICAqIElmIHJlbGF0aXZlIHdpbGwgYWRkIHRvIHRoZSB7YXJ0aWZhY3RfcGF0aH0KICAgIDpwYXJhbSBqYXJzOiAgICAgICAgQ29tbWEtc2VwYXJhdGVkIGxpc3Qgb2YgamFycyB0byBpbmNsdWRlIG9uIHRoZSBkcml2ZXIKICAgICAgICAgICAgICAgICAgICAgICAgYW5kIGV4ZWN1dG9yIGNsYXNzcGF0aHMuCiAgICA6cGFyYW0gcGFja2FnZXM6ICAgIENvbW1hLXNlcGFyYXRlZCBsaXN0IG9mIG1hdmVuIGNvb3JkaW5hdGVzIG9mIGphcnMgdG8gaW5jbHVkZQogICAgICAgICAgICAgICAgICAgICAgICBvbiB0aGUgZHJpdmVyIGFuZCBleGVjdXRvciBjbGFzc3BhdGhzLiBXaWxsIHNlYXJjaCB0aGUgbG9jYWwKICAgICAgICAgICAgICAgICAgICAgICAgbWF2ZW4gcmVwbywgdGhlbiBtYXZlbiBjZW50cmFsIGFuZCBhbnkgYWRkaXRpb25hbCByZW1vdGUKICAgICAgICAgICAgICAgICAgICAgICAgcmVwb3NpdG9yaWVzIGdpdmVuIGJ5IC0tcmVwb3NpdG9yaWVzLiBUaGUgZm9ybWF0IGZvciB0aGUKICAgIDpwYXJhbSBzcGFya19vcHRpb25zOiBzcGFyayBwYXJhbWV0ZXMgdGhhdCBhcmUgbm90IGluY2x1ZGVkIGFzIGZ1bmN0aW9uIGFyZ3VtZW50cwogICAgOnBhcmFtIHB5c3BhcmtfY29tbWFuZDogQSBweXRob24gc2NyaXB0IG9yIEp1cHl0ZXIgbm90ZWJvb2sgdG8gYmUgZXhlY3V0ZWQKICAgIDpwYXJhbSBweXNwYXJrX3BhcmFtczogIHBhcmFtZXRlcnMgdG8gdGhlIHB5dGhvbiBzY3JpcHQKCiAgICAiIiIKICAgIGNtZCA9IHNwYXJrX2NvbW1hbmRfYnVpbGRlcihuYW1lLCBjbGFzc19uYW1lLCBqYXJzLCBwYWNrYWdlcywgc3Bhcmtfb3B0aW9ucyxweXNwYXJrX2NvbW1hbmQscHlzcGFya19wYXJhbXMpCiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCJzdWJtaXRpbmcgOiIgKyBjbWQpCgogICAgY2xpID0gSzhTQ2xpZW50KGNvbnRleHQubG9nZ2VyKQogICAgY2xpLmV4ZWNfc2hlbGxfY21kKGNtZCxzaGVsbF9wb2RfbmFtZT1zaGVsbF9wb2RfbmFtZSkKCg==
    commands: []
    code_origin: https://github.com/Michaelliv/functions.git#b6d661b4f8ad3f3a632a5024f679a4babbb04395:/home/michaell/projects/functions/spark_submit/spark_submit.ipynb
verbose: false
