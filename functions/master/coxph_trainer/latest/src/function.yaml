kind: job
metadata:
  name: coxph-trainer
  tag: ''
  hash: a578a6ce19aa1914cb579d72c0a4ec4623afdf0f
  project: default
  labels:
    author: yjb
    framework: survival
  categories:
  - training
  - ml
spec:
  command: ''
  args: []
  image: mlrun/ml-models
  env: []
  default_handler: train_model
  entry_points:
    train_model:
      name: train_model
      doc: "train models to predict the timing of events\n\nAlthough identical in\
        \ structure to other training functions, this one\nrequires generating a 'Y'\
        \ that represents the age/duration/tenure of\nthe obervation, designated 'tenure'\
        \ here, and a binary labels columns that\nrepresents the event of interest,\
        \ churned/not-churned.\n\nIn addition, there is a strata_cols parameter, representing\
        \ a list of \nstratification (aka grouping) variables."
      parameters:
      - name: context
        type: MLClientCtx
        doc: the function context
        default: ''
      - name: dataset
        type: DataItem
        doc: ("data") name of raw data file
        default: ''
      - name: event_column
        type: str
        doc: ground-truth (y) labels (considered as events in this model)
        default: labels
      - name: time_column
        type: str
        doc: age or tenure column
        default: tenure
      - name: encode_cols
        type: dict
        doc: dictionary of names and prefixes for columns that are to hot be encoded.
        default: {}
      - name: strata_cols
        type: list
        doc: columns used to stratify predictors
        default: []
      - name: plot_cov_groups
        type: bool
        default: false
      - name: p_value
        type: float
        doc: (0.005) max p value for coeffcients selected
        default: 0.005
      - name: sample
        type: int
        doc: Selects the first n rows, or select a sample starting from the first.
          If negative <-1, select a random sample
        default: <_ast.USub object at 0x7f4a7baa27b8>
      - name: test_size
        type: float
        doc: (0.25) test set size
        default: 0.25
      - name: valid_size
        type: float
        doc: (0.75) Once the test set has been removed the training set gets this
          proportion.
        default: 0.75
      - name: random_state
        type: int
        doc: (1) sklearn rng seed
        default: 1
      - name: models_dest
        type: str
        doc: destination subfolder for model artifacts
        default: ''
      - name: plots_dest
        type: str
        doc: destination subfolder for plot artifacts
        default: ''
      - name: file_ext
        type: str
        doc: format for test_set_key hold out data
        default: csv
      outputs:
      - default: ''
      lineno: 85
  description: cox proportional hazards, kaplan meier plots
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlcgoKaW1wb3J0IHdhcm5pbmdzCndhcm5pbmdzLnNpbXBsZWZpbHRlcihhY3Rpb249Imlnbm9yZSIsIGNhdGVnb3J5PUZ1dHVyZVdhcm5pbmcpCgpmcm9tIG1scnVuLm1sdXRpbHMuZGF0YSBpbXBvcnQgZ2V0X3NhbXBsZSwgZ2V0X3NwbGl0cwpmcm9tIG1scnVuLm1sdXRpbHMucGxvdHMgaW1wb3J0IGdjZl9jbGVhcgoKZnJvbSBtbHJ1bi5leGVjdXRpb24gaW1wb3J0IE1MQ2xpZW50Q3R4CmZyb20gbWxydW4uZGF0YXN0b3JlIGltcG9ydCBEYXRhSXRlbQpmcm9tIG1scnVuLmFydGlmYWN0cyBpbXBvcnQgUGxvdEFydGlmYWN0LCBUYWJsZUFydGlmYWN0Cgpmcm9tIGNsb3VkcGlja2xlIGltcG9ydCBkdW1wcwppbXBvcnQgcGFuZGFzIGFzIHBkCmltcG9ydCBvcwoKZnJvbSBsaWZlbGluZXMgaW1wb3J0IENveFBIRml0dGVyLCBLYXBsYW5NZWllckZpdHRlcgoKZGVmIF9jb3hwaF9sb2dfbW9kZWwoCiAgICBjb250ZXh0LAogICAgbW9kZWwsIAogICAgZGF0YXNldF9rZXk6IHN0ciAgPSAiY294aGF6YXJkLXN1bW1hcnkiLAogICAgbW9kZWxzX2Rlc3Q6IHN0ciA9ICJtb2RlbHMiLAogICAgcGxvdF9jb3ZfZ3JvdXBzOiBib29sID0gRmFsc2UsCiAgICBwX3ZhbHVlOiBmbG9hdCA9IDAuMDA1LAogICAgcGxvdF9rZXk6IHN0ciAgPSAia20tY3giLAogICAgcGxvdHNfZGVzdDogc3RyID0gInBsb3RzIiwKICAgIGZpbGVfZXh0PSJjc3YiLAogICAgZXh0cmFfZGF0YTogZGljdCA9IHt9Cik6CiAgICAiIiJsb2cgYSBjb3hwaCBtb2RlbCAoYW5kIHN1Ym1vZGVsIGxvY2F0aW9ucykKICAgIAogICAgOnBhcmFtIG1vZGVsOiAgICAgICAgZXN0aW1hdGVkIGNveHBoIG1vZGVsCiAgICA6cGFyYW0gZXh0cmFfZGF0YTogICBpZiB0aGlzIG1vZGVsIHdhbnRzIHRvIHN0b3JlIHRoZSBsb2NhdGlvbnMgb2Ygc3VibW9kZWxzCiAgICAgICAgICAgICAgICAgICAgICAgICB1c2UgdGhpcwogICAgIiIiCiAgICBpbXBvcnQgbWF0cGxvdGxpYi5weXBsb3QgYXMgcGx0CiAgICAKICAgIHN1bXRibCA9IG1vZGVsLnN1bW1hcnkKICAgIAogICAgY29udGV4dC5sb2dfZGF0YXNldChkYXRhc2V0X2tleSwgZGY9c3VtdGJsLAogICAgICAgICAgICAgICAgICAgICAgICBpbmRleD1UcnVlLCBmb3JtYXQ9ZmlsZV9leHQpCgogICAgbW9kZWxfYmluID0gZHVtcHMobW9kZWwpCiAgICBjb250ZXh0LmxvZ19tb2RlbCgiY3gtbW9kZWwiLCBib2R5PW1vZGVsX2JpbiwgCiAgICAgICAgICAgICAgICAgICAgICBhcnRpZmFjdF9wYXRoPW9zLnBhdGguam9pbihjb250ZXh0LmFydGlmYWN0X3BhdGgsIG1vZGVsc19kZXN0KSwKICAgICAgICAgICAgICAgICAgICAgIG1vZGVsX2ZpbGU9Im1vZGVsLnBrbCIpCiAgICBpZiBwbG90X2Nvdl9ncm91cHM6CiAgICAgICAgc2VsZWN0X2NvdmFycyA9IHN1bW1hcnlbc3VtbWFyeS5wPD1wX3ZhbHVlXS5pbmRleC52YWx1ZXMKICAgICAgICBmb3IgZ3JvdXAgaW4gc2VsZWN0X2NvdmFyczoKICAgICAgICAgICAgYXhzID0gbW9kZWwucGxvdF9jb3ZhcmlhdGVfZ3JvdXBzKGdyb3VwLCB2YWx1ZXM9WzAsIDFdKQogICAgICAgICAgICBmb3IgaXgsIGF4IGluIGVudW1lcmF0ZShheHMpOgogICAgICAgICAgICAgICAgZiA9IGF4LmdldF9maWd1cmUoKQogICAgICAgICAgICAgICAgY29udGV4dC5sb2dfYXJ0aWZhY3QoCiAgICAgICAgICAgICAgICAgICAgUGxvdEFydGlmYWN0KGYiY3gte2dyb3VwfS17aXh9IiwgYm9keT1wbHQuZ2NmKCkpLCAKICAgICAgICAgICAgICAgICAgICBsb2NhbF9wYXRoPWYie3Bsb3RzX2Rlc3R9L2N4LXtncm91cH0te2l4fS5odG1sIikKICAgICAgICAgICAgICAgIGdjZl9jbGVhcihwbHQpCgpkZWYgX2thcGxhbl9tZWllcl9sb2dfbW9kZWwoCiAgICBjb250ZXh0LAogICAgbW9kZWwsIAogICAgdGltZV9jb2x1bW46IHN0ciA9ICJ0ZW51cmUiLAogICAgZGF0YXNldF9rZXk6IHN0ciAgPSAia20tdGltZWxpbmVzIiwKICAgIHBsb3Rfa2V5OiBzdHIgID0gImttLXN1cnZpdmFsIiwKICAgIHBsb3RzX2Rlc3Q6IHN0ciA9ICJwbG90cyIsCiAgICBtb2RlbHNfZGVzdDogc3RyID0gIm1vZGVscyIsCiAgICBmaWxlX2V4dDogc3RyID0gImNzdiIKKToKICAgIGltcG9ydCBtYXRwbG90bGliLnB5cGxvdCBhcyBwbHQKICAgIG8gPSBbXQogICAgZm9yIG9iaiBpbiBtb2RlbC5fX2RpY3RfXy5rZXlzKCk6CiAgICAgICAgaWYgaXNpbnN0YW5jZShtb2RlbC5fX2RpY3RfX1tvYmpdLCBwZC5EYXRhRnJhbWUpOgogICAgICAgICAgICBvLmFwcGVuZChtb2RlbC5fX2RpY3RfX1tvYmpdKQogICAgZGYgPSBwZC5jb25jYXQobywgYXhpcz0xKQogICAgZGYuaW5kZXgubmFtZSA9IHRpbWVfY29sdW1uCiAgICBjb250ZXh0LmxvZ19kYXRhc2V0KGRhdGFzZXRfa2V5LCBkZj1kZiwgaW5kZXg9VHJ1ZSwgZm9ybWF0PWZpbGVfZXh0KQogICAgbW9kZWwucGxvdCgpCiAgICBjb250ZXh0LmxvZ19hcnRpZmFjdChQbG90QXJ0aWZhY3QocGxvdF9rZXksIGJvZHk9cGx0LmdjZigpKSwgCiAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbF9wYXRoPWYie3Bsb3RzX2Rlc3R9L3twbG90X2tleX0uaHRtbCIpCiAgICBjb250ZXh0LmxvZ19tb2RlbCgia20tbW9kZWwiLCAKICAgICAgICAgICAgICAgICAgICAgIGJvZHk9ZHVtcHMobW9kZWwpLCAKICAgICAgICAgICAgICAgICAgICAgIG1vZGVsX2Rpcj1mInttb2RlbHNfZGVzdH0va20iLCAKICAgICAgICAgICAgICAgICAgICAgIG1vZGVsX2ZpbGU9Im1vZGVsLnBrbCIpCgpkZWYgdHJhaW5fbW9kZWwoCiAgICBjb250ZXh0OiBNTENsaWVudEN0eCwKICAgIGRhdGFzZXQ6IERhdGFJdGVtLAogICAgZXZlbnRfY29sdW1uOiBzdHIgPSAibGFiZWxzIiwKICAgIHRpbWVfY29sdW1uOiBzdHIgPSAidGVudXJlIiwKICAgIGVuY29kZV9jb2xzOiBkaWN0ID0ge30sCiAgICBzdHJhdGFfY29sczogbGlzdCA9IFtdLAogICAgcGxvdF9jb3ZfZ3JvdXBzOiBib29sID0gRmFsc2UsCiAgICBwX3ZhbHVlOiBmbG9hdCA9IDAuMDA1LAogICAgc2FtcGxlOiBpbnQgPSAtMSwKICAgIHRlc3Rfc2l6ZTogZmxvYXQgPSAwLjI1LAogICAgdmFsaWRfc2l6ZTogZmxvYXQgPSAwLjc1LCAjIChhZnRlciB0ZXN0IHJlbW92ZWQpCiAgICByYW5kb21fc3RhdGU6IGludCA9IDEsCiAgICBtb2RlbHNfZGVzdDogc3RyID0gIiIsCiAgICBwbG90c19kZXN0OiBzdHIgPSAiIiwKICAgIGZpbGVfZXh0OiBzdHIgPSAiY3N2IiwKKSAtPiBOb25lOgogICAgIiIidHJhaW4gbW9kZWxzIHRvIHByZWRpY3QgdGhlIHRpbWluZyBvZiBldmVudHMKICAgIAogICAgQWx0aG91Z2ggaWRlbnRpY2FsIGluIHN0cnVjdHVyZSB0byBvdGhlciB0cmFpbmluZyBmdW5jdGlvbnMsIHRoaXMgb25lCiAgICByZXF1aXJlcyBnZW5lcmF0aW5nIGEgJ1knIHRoYXQgcmVwcmVzZW50cyB0aGUgYWdlL2R1cmF0aW9uL3RlbnVyZSBvZgogICAgdGhlIG9iZXJ2YXRpb24sIGRlc2lnbmF0ZWQgJ3RlbnVyZScgaGVyZSwgYW5kIGEgYmluYXJ5IGxhYmVscyBjb2x1bW5zIHRoYXQKICAgIHJlcHJlc2VudHMgdGhlIGV2ZW50IG9mIGludGVyZXN0LCBjaHVybmVkL25vdC1jaHVybmVkLgogICAgCiAgICBJbiBhZGRpdGlvbiwgdGhlcmUgaXMgYSBzdHJhdGFfY29scyBwYXJhbWV0ZXIsIHJlcHJlc2VudGluZyBhIGxpc3Qgb2YgCiAgICBzdHJhdGlmaWNhdGlvbiAoYWthIGdyb3VwaW5nKSB2YXJpYWJsZXMuCiAgICAKICAgIDpwYXJhbSBjb250ZXh0OiAgICAgICAgICAgdGhlIGZ1bmN0aW9uIGNvbnRleHQKICAgIDpwYXJhbSBkYXRhc2V0OiAgICAgICAgICAgKCJkYXRhIikgbmFtZSBvZiByYXcgZGF0YSBmaWxlCiAgICA6cGFyYW0gZXZlbnRfY29sdW1uOiAgICAgIGdyb3VuZC10cnV0aCAoeSkgbGFiZWxzIChjb25zaWRlcmVkIGFzIGV2ZW50cyBpbiB0aGlzIG1vZGVsKQogICAgOnBhcmFtIHRpbWVfY29sdW1uOiAgICAgICBhZ2Ugb3IgdGVudXJlIGNvbHVtbgogICAgOnBhcmFtIGVuY29kZV9jb2xzOiAgICAgICBkaWN0aW9uYXJ5IG9mIG5hbWVzIGFuZCBwcmVmaXhlcyBmb3IgY29sdW1ucyB0aGF0IGFyZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0byBob3QgYmUgZW5jb2RlZC4KICAgIDpwYXJhbSBzdHJhdGFfY29sczogICAgICAgY29sdW1ucyB1c2VkIHRvIHN0cmF0aWZ5IHByZWRpY3RvcnMKICAgIDpwYXJhbSBwbG90X2Nvdl9ncm91cHM6ICAgCiAgICA6cGFyYW0gcF92YWx1ZTogICAgICAgICAgICgwLjAwNSkgbWF4IHAgdmFsdWUgZm9yIGNvZWZmY2llbnRzIHNlbGVjdGVkCiAgICA6cGFyYW0gc2FtcGxlOiAgICAgICAgICAgIFNlbGVjdHMgdGhlIGZpcnN0IG4gcm93cywgb3Igc2VsZWN0IGEgc2FtcGxlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0aW5nIGZyb20gdGhlIGZpcnN0LiBJZiBuZWdhdGl2ZSA8LTEsIHNlbGVjdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhIHJhbmRvbSBzYW1wbGUKICAgIDpwYXJhbSB0ZXN0X3NpemU6ICAgICAgICAgKDAuMjUpIHRlc3Qgc2V0IHNpemUKICAgIDpwYXJhbSB2YWxpZF9zaXplOiAgICAgICAgKDAuNzUpIE9uY2UgdGhlIHRlc3Qgc2V0IGhhcyBiZWVuIHJlbW92ZWQgdGhlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYWluaW5nIHNldCBnZXRzIHRoaXMgcHJvcG9ydGlvbi4KICAgIDpwYXJhbSByYW5kb21fc3RhdGU6ICAgICAgKDEpIHNrbGVhcm4gcm5nIHNlZWQKICAgIDpwYXJhbSBtb2RlbHNfZGVzdDogICAgICAgZGVzdGluYXRpb24gc3ViZm9sZGVyIGZvciBtb2RlbCBhcnRpZmFjdHMKICAgIDpwYXJhbSBwbG90c19kZXN0OiAgICAgICAgZGVzdGluYXRpb24gc3ViZm9sZGVyIGZvciBwbG90IGFydGlmYWN0cwogICAgOnBhcmFtIGZpbGVfZXh0OiAgICAgICAgICBmb3JtYXQgZm9yIHRlc3Rfc2V0X2tleSBob2xkIG91dCBkYXRhCiAgICAiIiIKICAgIGZyb20gbGlmZWxpbmVzLnBsb3R0aW5nIGltcG9ydCBwbG90X2xpZmV0aW1lcwogICAgaW1wb3J0IG1hdHBsb3RsaWIucHlwbG90IGFzIHBsdAoKICAgIG1vZGVsc19kZXN0ID0gbW9kZWxzX2Rlc3Qgb3IgIm1vZGVscyIKICAgIHBsb3RzX2Rlc3QgPSBwbG90c19kZXN0IG9yIGYicGxvdHMve2NvbnRleHQubmFtZX0iCiAgICAKICAgIHJhdywgdGVudXJlLCBoZWFkZXIgPSBnZXRfc2FtcGxlKGRhdGFzZXQsIHNhbXBsZSwgdGltZV9jb2x1bW4pCgogICAgaWYgZW5jb2RlX2NvbHM6CiAgICAgICAgcmF3ID0gcGQuZ2V0X2R1bW1pZXMocmF3LCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5zPWxpc3QoZW5jb2RlX2NvbHMua2V5cygpKSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlZml4PWxpc3QoZW5jb2RlX2NvbHMudmFsdWVzKCkpLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkcm9wX2ZpcnN0PVRydWUpCgogICAgKHh0cmFpbiwgeXRyYWluKSwgKHh2YWxpZCwgeXZhbGlkKSwgKHh0ZXN0LCB5dGVzdCkgICAgICAgICA9IGdldF9zcGxpdHMocmF3LCB0ZW51cmUsIDMsIHRlc3Rfc2l6ZSwgdmFsaWRfc2l6ZSwgcmFuZG9tX3N0YXRlKQogICAgZm9yIFggaW4gW3h0cmFpbiwgeHZhbGlkLCB4dGVzdF06CiAgICAgICAgZHJvcF9jb2xzID0gWC5jb2x1bW5zLnN0ci5zdGFydHN3aXRoKHRpbWVfY29sdW1uKQogICAgICAgIFguZHJvcChYLmNvbHVtbnNbZHJvcF9jb2xzXSwgYXhpcz0xLCBpbnBsYWNlPVRydWUpCiAgICBmb3IgWSBpbiBbeXRyYWluLCB5dmFsaWQsIHl0ZXN0XToKICAgICAgICBZLm5hbWUgPSB0aW1lX2NvbHVtbgogICAgCiAgICBjb250ZXh0LmxvZ19kYXRhc2V0KCJ0ZW51cmVkLXRlc3Qtc2V0IiwgCiAgICAgICAgICAgICAgICAgICAgICAgIGRmPXBkLmNvbmNhdChbeHRlc3QsIHl0ZXN0LnRvX2ZyYW1lKCldLCBheGlzPTEpLCAKICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0PWZpbGVfZXh0LCBpbmRleD1GYWxzZSkKCiAgICBrbV9tb2RlbCA9IEthcGxhbk1laWVyRml0dGVyKCkuZml0KHl0cmFpbiwgeHRyYWluLmxhYmVscykKICAgIF9rYXBsYW5fbWVpZXJfbG9nX21vZGVsKGNvbnRleHQsIGttX21vZGVsLCBtb2RlbHNfZGVzdD1tb2RlbHNfZGVzdCkKICAgIAogICAgY294ZGF0YSA9IHBkLmNvbmNhdChbeHRyYWluLCB5dHJhaW4udG9fZnJhbWUoKV0sIGF4aXM9MSkKICAgIGN4X21vZGVsID0gQ294UEhGaXR0ZXIoKS5maXQoY294ZGF0YSwgdGltZV9jb2x1bW4sIGV2ZW50X2NvbHVtbiwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmF0YT1zdHJhdGFfY29scykgICAgCiAgICBfY294cGhfbG9nX21vZGVsKGNvbnRleHQsIGN4X21vZGVsLCBtb2RlbHNfZGVzdD1tb2RlbHNfZGVzdCwgCiAgICAgICAgICAgICAgICAgICAgIHBsb3RfY292X2dyb3Vwcz1wbG90X2Nvdl9ncm91cHMsIAogICAgICAgICAgICAgICAgICAgICBleHRyYV9kYXRhPXsia20iOiBmInttb2RlbHNfZGVzdH0va20ifSkKCg==
    commands: []
    code_origin: https://github.com/mlrun/functions.git#8a7816038d1e23362b562eb2229032d34320ecce:/home/michaell/projects/temp/functions/coxph_trainer/coxph_trainer.ipynb
verbose: false
